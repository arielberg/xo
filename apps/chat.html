<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Simple WebRTC Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
</head>
<body>
  <h3>WebRTC Chat (Firebase Signaling)</h3>
  <textarea id="chat" rows="10" cols="50" readonly></textarea><br>
  <input id="msg" placeholder="Type message"><button onclick="sendMsg()">Send</button>
  <br><br>
  <button onclick="createOffer()">Create Offer</button>
  <button onclick="createAnswer()">Create Answer</button>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDZoAIkXAI6UIDjf4-_tf95cU6d7HRhIEM",
        authDomain: "chats-b5c11.firebaseapp.com",
        projectId: "chats-b5c11",
        storageBucket: "chats-b5c11.firebasestorage.app",
        messagingSenderId: "956853038243",
        appId: "1:956853038243:web:d42d2f99b71777b13de316",
        measurementId: "G-8S3Q3X72KG"
      };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pc = new RTCPeerConnection();
let channel = pc.createDataChannel("chat");
channel.onmessage = e => chat.value += "Peer: " + e.data + "\n";

pc.onicecandidate = e => {
  if (e.candidate) {
    db.ref("candidates").push(JSON.stringify(e.candidate));
  }
};

db.ref("candidates").on("child_added", async snap => {
    let cand = new RTCIceCandidate(JSON.parse(snap.val()));
    if (pc.remoteDescription) {           // ✅ יש RemoteDescription
      try {
        await pc.addIceCandidate(cand);
      } catch (e) {
        console.error("Error adding candidate", e);
      }
    } else {
      console.log("Candidate ignored, no remoteDescription yet");
    }
  });

async function createOffer() {
  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref("offer").set(JSON.stringify(offer));
}

async function createAnswer() {
  let snap = await db.ref("offer").get();
  let offer = JSON.parse(snap.val());
  await pc.setRemoteDescription(offer);
  let answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.ref("answer").set(JSON.stringify(answer));
}

db.ref("answer").on("value", async snap => {
  if (snap.val()) {
    let ans = JSON.parse(snap.val());
    await pc.setRemoteDescription(ans);
  }
});

function sendMsg() {
  channel.send(msg.value);
  chat.value += "Me: " + msg.value + "\n";
  msg.value = "";
}
</script>
</body>
</html>
